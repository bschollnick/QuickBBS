<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benchmark Comparison Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .file-upload {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 30px;
        }

        .file-upload label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .file-upload input[type="file"] {
            display: block;
            width: 100%;
            padding: 10px;
            border: 2px dashed #3498db;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }

        .file-upload input[type="file"]:hover {
            border-color: #2980b9;
            background: #f8f9fa;
        }

        .instructions {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .instructions p {
            margin: 5px 0;
            font-size: 14px;
        }

        .loaded-files {
            margin-bottom: 30px;
        }

        .loaded-files h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
        }

        .file-badge {
            display: inline-block;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .file-badge-1 { background: #3498db; color: white; }
        .file-badge-2 { background: #2ecc71; color: white; }
        .file-badge-3 { background: #e74c3c; color: white; }
        .file-badge-4 { background: #f39c12; color: white; }
        .file-badge-5 { background: #9b59b6; color: white; }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 22px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background: #34495e;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .metric-positive {
            color: #27ae60;
            font-weight: 600;
        }

        .metric-negative {
            color: #e74c3c;
            font-weight: 600;
        }

        .metric-neutral {
            color: #7f8c8d;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 40px;
        }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin-top: 10px;
            font-size: 13px;
            color: #856404;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
            font-size: 16px;
        }

        .color-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .color-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Benchmark Comparison Dashboard</h1>
        <p class="subtitle">Compare QuickBBS download benchmark results side-by-side</p>

        <div class="instructions">
            <p><strong>üìÅ How to use:</strong></p>
            <p>1. Select up to 5 JSON benchmark files from your <code>benchmark_results/</code> directory</p>
            <p>2. Files are named like: <code>benchmark_20251024_194058.json</code></p>
            <p>3. Charts and comparisons will update automatically</p>
        </div>

        <div class="file-upload">
            <label for="fileInput">Select Benchmark JSON Files (up to 5):</label>
            <input type="file" id="fileInput" accept=".json" multiple>
        </div>

        <div id="loadedFilesContainer" class="loaded-files" style="display: none;">
            <h3>Loaded Benchmark Runs:</h3>
            <div id="loadedFilesList"></div>
        </div>

        <div id="dashboardContent" style="display: none;">
            <!-- Server Configuration -->
            <div class="section">
                <h2>üñ•Ô∏è Server Configuration</h2>
                <table id="serverConfigTable">
                    <thead>
                        <tr>
                            <th>Setting</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Overall Performance Metrics -->
            <div class="section">
                <h2>üìà Overall Performance Metrics</h2>
                <table id="metricsTable">
                    <thead>
                        <tr>
                            <th>Metric</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Charts -->
            <div class="section">
                <h2>üìä Performance Charts</h2>

                <div class="color-legend" id="chartLegend"></div>

                <div class="chart-row">
                    <div class="chart-container">
                        <canvas id="rpsChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="latencyChart"></canvas>
                    </div>
                </div>

                <div class="chart-row">
                    <div class="chart-container">
                        <canvas id="transferRateChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="failureRateChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Per-Endpoint Breakdown -->
            <div class="section">
                <h2>üéØ Per-Endpoint Performance</h2>
                <div id="endpointCharts"></div>
            </div>
        </div>

        <div id="noDataMessage" class="no-data">
            <p>üëÜ Select JSON benchmark files above to start comparing results</p>
        </div>
    </div>

    <script>
        const colors = [
            '#3498db', // Blue
            '#2ecc71', // Green
            '#e74c3c', // Red
            '#f39c12', // Orange
            '#9b59b6', // Purple
        ];

        let benchmarkData = [];
        let charts = {};

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const files = Array.from(event.target.files).slice(0, 5);

            if (files.length === 0) {
                return;
            }

            benchmarkData = [];
            let filesLoaded = 0;

            files.forEach((file, index) => {
                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        benchmarkData.push({
                            filename: file.name,
                            data: data,
                            color: colors[index % colors.length]
                        });

                        filesLoaded++;

                        if (filesLoaded === files.length) {
                            updateDashboard();
                        }
                    } catch (error) {
                        console.error('Error parsing JSON:', error);
                        alert(`Error parsing ${file.name}: ${error.message}`);
                    }
                };

                reader.readAsText(file);
            });
        }

        function updateDashboard() {
            if (benchmarkData.length === 0) {
                document.getElementById('dashboardContent').style.display = 'none';
                document.getElementById('noDataMessage').style.display = 'block';
                return;
            }

            document.getElementById('dashboardContent').style.display = 'block';
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('loadedFilesContainer').style.display = 'block';

            updateLoadedFilesList();
            updateServerConfigTable();
            updateMetricsTable();
            updateCharts();
            updateEndpointCharts();
        }

        function updateLoadedFilesList() {
            const container = document.getElementById('loadedFilesList');
            container.innerHTML = benchmarkData.map((item, index) =>
                `<span class="file-badge file-badge-${index + 1}">${index + 1}. ${item.filename}</span>`
            ).join('');
        }

        function updateServerConfigTable() {
            const table = document.getElementById('serverConfigTable');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');

            // Update header
            thead.innerHTML = '<th>Setting</th>' + benchmarkData.map((item, i) =>
                `<th>Run ${i + 1}</th>`
            ).join('');

            // Server config fields
            const fields = [
                { key: 'server', label: 'Server Software' },
                { key: 'http_protocol', label: 'HTTP Protocol' },
                { key: 'connection', label: 'Connection Type' },
                { key: 'alt_svc', label: 'Alt-Svc Header' }
            ];

            tbody.innerHTML = fields.map(field => {
                const values = benchmarkData.map(item => {
                    const config = item.data.server_config || {};
                    return config[field.key] || 'Unknown';
                });

                const allSame = values.every(v => v === values[0]);
                const warningClass = !allSame ? ' class="warning"' : '';

                return `
                    <tr${warningClass}>
                        <td><strong>${field.label}</strong></td>
                        ${values.map(v => `<td>${v || 'N/A'}</td>`).join('')}
                    </tr>
                `;
            }).join('');
        }

        function updateMetricsTable() {
            const table = document.getElementById('metricsTable');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');

            // Update header
            thead.innerHTML = '<th>Metric</th>' + benchmarkData.map((item, i) =>
                `<th>Run ${i + 1}</th>`
            ).join('');

            const metrics = [
                { key: 'requests', label: 'Total Requests', format: v => v.toLocaleString(), higher: true },
                { key: 'failures', label: 'Failed Requests', format: v => v.toLocaleString(), higher: false },
                { key: 'rps', label: 'Requests/sec', format: v => v.toFixed(2), higher: true },
                { key: 'avg_ms', label: 'Avg Latency (ms)', format: v => v.toFixed(1), higher: false },
                { key: 'median_ms', label: 'Median Latency (ms)', format: v => v.toFixed(1), higher: false },
                { key: 'p95_ms', label: 'P95 Latency (ms)', format: v => v.toFixed(1), higher: false },
                { key: 'p99_ms', label: 'P99 Latency (ms)', format: v => v.toFixed(1), higher: false },
            ];

            tbody.innerHTML = metrics.map(metric => {
                const values = benchmarkData.map(item => item.data.total[metric.key] || 0);
                const maxValue = Math.max(...values);
                const minValue = Math.min(...values);

                return `
                    <tr>
                        <td><strong>${metric.label}</strong></td>
                        ${values.map(v => {
                            let className = 'metric-neutral';
                            if (values.length > 1) {
                                if (metric.higher) {
                                    className = v === maxValue ? 'metric-positive' : (v === minValue ? 'metric-negative' : 'metric-neutral');
                                } else {
                                    className = v === minValue ? 'metric-positive' : (v === maxValue ? 'metric-negative' : 'metric-neutral');
                                }
                            }
                            return `<td class="${className}">${metric.format(v)}</td>`;
                        }).join('')}
                    </tr>
                `;
            }).join('');

            // Add transfer rate row
            const transferRates = benchmarkData.map(item => {
                const total = item.data.total;
                const bytesPerSec = (total.avg_size_bytes || 0) * (total.rps || 0);
                return formatBytes(bytesPerSec);
            });

            tbody.innerHTML += `
                <tr>
                    <td><strong>Transfer Rate</strong></td>
                    ${transferRates.map(rate => `<td>${rate}/sec</td>`).join('')}
                </tr>
            `;
        }

        function updateCharts() {
            // Color legend
            const legend = document.getElementById('chartLegend');
            legend.innerHTML = benchmarkData.map((item, i) => `
                <div class="color-legend-item">
                    <div class="color-box" style="background-color: ${item.color}"></div>
                    <span>Run ${i + 1}: ${item.filename}</span>
                </div>
            `).join('');

            // RPS Chart
            updateChart('rpsChart', 'Requests Per Second (Higher is Better)',
                benchmarkData.map(item => item.data.total.rps || 0));

            // Latency Chart
            updateLatencyChart();

            // Transfer Rate Chart
            updateTransferRateChart();

            // Failure Rate Chart
            updateFailureRateChart();
        }

        function updateChart(canvasId, title, values) {
            const ctx = document.getElementById(canvasId);

            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: benchmarkData.map((item, i) => `Run ${i + 1}`),
                    datasets: [{
                        label: title,
                        data: values,
                        backgroundColor: benchmarkData.map(item => item.color),
                        borderColor: benchmarkData.map(item => item.color),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateLatencyChart() {
            const ctx = document.getElementById('latencyChart');

            if (charts['latencyChart']) {
                charts['latencyChart'].destroy();
            }

            const datasets = ['median_ms', 'p95_ms', 'p99_ms'].map((metric, index) => ({
                label: metric === 'median_ms' ? 'Median' : (metric === 'p95_ms' ? 'P95' : 'P99'),
                data: benchmarkData.map(item => item.data.total[metric] || 0),
                backgroundColor: `rgba(${index * 80}, ${100 + index * 40}, ${200 - index * 50}, 0.6)`,
                borderColor: `rgb(${index * 80}, ${100 + index * 40}, ${200 - index * 50})`,
                borderWidth: 2
            }));

            charts['latencyChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: benchmarkData.map((item, i) => `Run ${i + 1}`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Latency Percentiles (Lower is Better)',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Milliseconds'
                            }
                        }
                    }
                }
            });
        }

        function updateTransferRateChart() {
            const ctx = document.getElementById('transferRateChart');

            if (charts['transferRateChart']) {
                charts['transferRateChart'].destroy();
            }

            const transferRates = benchmarkData.map(item => {
                const total = item.data.total;
                const bytesPerSec = (total.avg_size_bytes || 0) * (total.rps || 0);
                return bytesPerSec / (1024 * 1024); // Convert to MB/s
            });

            charts['transferRateChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: benchmarkData.map((item, i) => `Run ${i + 1}`),
                    datasets: [{
                        label: 'Transfer Rate (MB/s)',
                        data: transferRates,
                        backgroundColor: benchmarkData.map(item => item.color),
                        borderColor: benchmarkData.map(item => item.color),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Transfer Rate (Higher is Better)',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'MB/sec'
                            }
                        }
                    }
                }
            });
        }

        function updateFailureRateChart() {
            const ctx = document.getElementById('failureRateChart');

            if (charts['failureRateChart']) {
                charts['failureRateChart'].destroy();
            }

            const failureRates = benchmarkData.map(item => {
                const total = item.data.total;
                const totalRequests = total.requests || 0;
                const failures = total.failures || 0;
                return totalRequests > 0 ? (failures / totalRequests * 100) : 0;
            });

            charts['failureRateChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: benchmarkData.map((item, i) => `Run ${i + 1}`),
                    datasets: [{
                        label: 'Failure Rate (%)',
                        data: failureRates,
                        backgroundColor: failureRates.map(rate => rate > 0 ? '#e74c3c' : '#2ecc71'),
                        borderColor: failureRates.map(rate => rate > 0 ? '#c0392b' : '#27ae60'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Failure Rate (Lower is Better)',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Percentage'
                            }
                        }
                    }
                }
            });
        }

        function updateEndpointCharts() {
            const container = document.getElementById('endpointCharts');

            // Get all unique endpoints
            const allEndpoints = new Set();
            benchmarkData.forEach(item => {
                Object.keys(item.data.endpoints || {}).forEach(ep => allEndpoints.add(ep));
            });

            if (allEndpoints.size === 0) {
                container.innerHTML = '<p class="no-data">No endpoint data available</p>';
                return;
            }

            container.innerHTML = '';

            allEndpoints.forEach(endpoint => {
                const section = document.createElement('div');
                section.style.marginBottom = '40px';

                const title = document.createElement('h3');
                title.textContent = endpoint;
                title.style.marginBottom = '20px';
                title.style.color = '#34495e';
                section.appendChild(title);

                // Create charts container
                const chartsRow = document.createElement('div');
                chartsRow.className = 'chart-row';

                // RPS chart
                const rpsContainer = document.createElement('div');
                rpsContainer.className = 'chart-container';
                const rpsCanvas = document.createElement('canvas');
                rpsCanvas.id = `endpoint-rps-${endpoint.replace(/\s+/g, '-')}`;
                rpsContainer.appendChild(rpsCanvas);
                chartsRow.appendChild(rpsContainer);

                // Latency chart
                const latencyContainer = document.createElement('div');
                latencyContainer.className = 'chart-container';
                const latencyCanvas = document.createElement('canvas');
                latencyCanvas.id = `endpoint-latency-${endpoint.replace(/\s+/g, '-')}`;
                latencyContainer.appendChild(latencyCanvas);
                chartsRow.appendChild(latencyContainer);

                section.appendChild(chartsRow);
                container.appendChild(section);

                // Create RPS chart
                const rpsData = benchmarkData.map(item => {
                    const ep = (item.data.endpoints || {})[endpoint];
                    return ep ? ep.rps : 0;
                });

                new Chart(rpsCanvas, {
                    type: 'bar',
                    data: {
                        labels: benchmarkData.map((item, i) => `Run ${i + 1}`),
                        datasets: [{
                            label: 'RPS',
                            data: rpsData,
                            backgroundColor: benchmarkData.map(item => item.color),
                            borderColor: benchmarkData.map(item => item.color),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Requests Per Second',
                                font: { size: 14, weight: 'bold' }
                            },
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });

                // Create Latency chart
                const datasets = ['median_ms', 'p95_ms', 'p99_ms'].map((metric, index) => ({
                    label: metric === 'median_ms' ? 'Median' : (metric === 'p95_ms' ? 'P95' : 'P99'),
                    data: benchmarkData.map(item => {
                        const ep = (item.data.endpoints || {})[endpoint];
                        return ep ? ep[metric] : 0;
                    }),
                    backgroundColor: `rgba(${index * 80}, ${100 + index * 40}, ${200 - index * 50}, 0.6)`,
                    borderColor: `rgb(${index * 80}, ${100 + index * 40}, ${200 - index * 50})`,
                    borderWidth: 2
                }));

                new Chart(latencyCanvas, {
                    type: 'bar',
                    data: {
                        labels: benchmarkData.map((item, i) => `Run ${i + 1}`),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Latency Percentiles',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Milliseconds'
                                }
                            }
                        }
                    }
                });
            });
        }

        function formatBytes(bytes) {
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let value = bytes;
            let unitIndex = 0;

            while (value >= 1024 && unitIndex < units.length - 1) {
                value /= 1024;
                unitIndex++;
            }

            return `${value.toFixed(2)} ${units[unitIndex]}`;
        }
    </script>
</body>
</html>
