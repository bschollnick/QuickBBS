<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
 <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <link rel="shortcut icon" type="image/png" href="/resources/images/open_folder_yellow.png" >

 <link rel="preload" href="/resources/css/bulma.min.css" as="style">
 <link rel="stylesheet" href="/resources/css/bulma.min.css">
 <link rel="preload" href="/resources/css/all.min.css" as="style">
 <link rel="stylesheet" href="/resources/css/all.min.css">

 <script src="/resources/javascript/htmx.min.js" defer></script>
{{ django_htmx_script() }}
 <title>{% block title %} {{ gallery_name }} {% endblock %}</title>
 <style>
 #spinner-overlay {
   display: none;
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background-color: rgba(0, 0, 0, 0.5);
   z-index: 9999;
   justify-content: center;
   align-items: center;
 }
 
 #spinner {
   background-color: white;
   padding: 4rem;
   border-radius: 16px;
   box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
   text-align: center;
   font-size: 1.5rem;
 }
 
 .spinner-icon {
   width: 80px;
   height: 80px;
   border: 8px solid #f3f3f3;
   border-top: 8px solid #3498db;
   border-radius: 50%;
   animation: spin 1s linear infinite;
   margin: 0 auto 2rem auto;
 }
 
 @keyframes spin {
   0% { transform: rotate(0deg); }
   100% { transform: rotate(360deg); }
 }
 </style>
 </head>
<body id="entire_document">
 <script>
 document.title = '{{ gallery_name }}'
 </script>
 
 <script>
 // Optimized spinner management with debouncing
 document.addEventListener("DOMContentLoaded", function() {
   let spinnerTimeout;
   let spinner = null;

   function getSpinner() {
     if (!spinner) {
       spinner = document.getElementById("spinner-overlay");
       if (!spinner) {
         spinner = document.createElement("div");
         spinner.id = "spinner-overlay";
         spinner.innerHTML = `
           <div id="spinner">
             <div class="spinner-icon"></div>
             <div>Loading...</div>
           </div>
         `;
         document.body.appendChild(spinner);
       }
     }
     return spinner;
   }

   function showSpinner() {
     clearTimeout(spinnerTimeout);
     const spinnerElement = getSpinner();
     if (spinnerElement) {
       spinnerElement.style.display = "flex";
     }
   }

   function hideSpinner() {
     clearTimeout(spinnerTimeout);
     spinnerTimeout = setTimeout(() => {
       const spinnerElement = getSpinner();
       if (spinnerElement) {
         spinnerElement.style.display = "none";
       }
     }, 100); // Debounce rapid hide calls
   }

   // Consolidated HTMX event handling
   document.addEventListener("htmx:beforeRequest", showSpinner);
   document.addEventListener("htmx:afterRequest", hideSpinner);
   document.addEventListener("htmx:afterSettle", hideSpinner);

   // Handle regular link clicks (non-HTMX)
   document.addEventListener("click", function(evt) {
     const target = evt.target.closest('a');
     if (target && target.href && !target.hasAttribute('hx-get') && !target.hasAttribute('hx-post')) {
       if (target.target !== '_blank' && target.target !== '_new') {
         showSpinner();
       }
     }
   });

   // Cleanup events
   window.addEventListener("load", hideSpinner);
   document.addEventListener("visibilitychange", function() {
     if (document.visibilityState === 'visible') {
       hideSpinner();
     }
   });
 });
 </script>

{% autoescape off %}
{% include 'frontend/gallery/gallery_listing_partial.jinja' %}
{% endautoescape %}
</body>
</html>