{# Gallery Item Card - Reusable component for displaying gallery items #}
{# Parameters expected: item, sort, loop.index #}
{% from 'macros/htmx.jinja' import show_htmx_attrs %}

{# Cache URLs and set HTMX attributes once #}
{% if item.filetype.is_link and item.virtual_directory %}
    {% set view_url = item.virtual_directory.get_view_url() %}
{% else %}
    {% set view_url = item.get_view_url() + "?sort=" + sort|string %}
{% endif %}
{% set thumbnail_url = item.get_thumbnail_url() %}
{% set htmx_html_attrs = show_htmx_attrs(swap='outerHTML transition:true') %}

{# Using CSS custom property for dynamic filetype color - more performant than inline background-color #}
<div class="gallery-item" style="--item-bg-color: #{{ item.filetype.color }};">
    <!-- Item Header -->
    <div class="item-header">
        <span class="item-index">{{ loop.index }}</span>
        <div class="item-title">
            <a href="{{ view_url }}"
               hx-get="{{ view_url }}"
               {{ htmx_html_attrs|safe }}
               class="gallery-item-link">
                {% if item.filetype.is_link %}
                    {{ item.name.split("*")[0] }}
                {% else %}
                    {{ item.name|wordwrap(width=24, break_long_words=True) }}
                {% endif %}
            </a>

            {% if item.is_animated %}
                <i class="fas fa-film film-indicator"></i>
            {% endif %}
        </div>
    </div>

    <!-- Thumbnail Container -->
    <div class="thumbnail-container">
        <figure class="image">
            <a href="{{ view_url }}"
               hx-get="{{ view_url }}"
               {{ htmx_html_attrs|safe }}
               class="gallery-item-link">
                <img src="{{ thumbnail_url }}"
                     alt="{{ item.name }}"
                     class="thumbnail thumbnail-image gallery-item"
                     {% if loop.index > 8 %}loading="lazy" data-lazy-timeout="5000"{% endif %}>
            </a>
        </figure>
        <!-- External Link -->
        <a href="{{ view_url }}"
            target="_blank"
            class="external-link"
            hx-boost="false">
            <i class="fas fa-external-link-alt"></i>
        </a>
    </div>

    <!-- Metadata -->
    <div class="item-metadata">
        {% if item.filetype.is_dir %}
            {% set directory_count = item.directory_count if item.directory_count is defined else item.get_dir_counts() %}
            {% if directory_count not in [0, None, "", -1] %}
                <div class="metadata-item">
                    <i class="far fa-folder"></i>
                    <span>{{ directory_count | intcomma }}</span>
                </div>
            {% endif %}

            {% set file_count = item.file_count if item.file_count is defined else item.get_file_counts() %}
            {% if file_count not in [0, None, "", -1] %}
                <div class="metadata-item">
                    <i class="far fa-file"></i>
                    <span>{{ file_count | intcomma }}</span>
                </div>
            {% endif %}
        {% endif %}

        <div class="metadata-item">
            <i class="far fa-calendar"></i>
            <span>{{ fromtimestamp(item.lastmod).strftime("%m/%d/%y %H:%M") }}</span>
        </div>

        {% if item.size and not item.filetype.is_movie and not item.filetype.is_dir %}
            <div class="metadata-item">
                <i class="far fa-ruler"></i>
                <span>{{ naturalsize(item.size, gnu=True) }}</span>
            </div>
        {% endif %}

        {% if item.filetype.is_movie %}
            <div class="metadata-item">
                <i class="far fa-clock"></i>
                <span>{{ precisedelta(item.duration) }}</span>
            </div>
        {% endif %}
    </div>
</div>
